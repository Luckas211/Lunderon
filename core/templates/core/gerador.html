{% extends 'core/base.html' %}
{% load static %}

{% block title %}Gerador de Vídeos - LUNDERON{% endblock %}

{% block extra_css %}
    {# Carrega o novo arquivo de estilo específico para esta página #}
    <link rel="stylesheet" href="{% static 'core/css/gerador-profissional.css' %}">
{% endblock %}


{% block content %}
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p class="loading-text">Gerando seu vídeo...</p>
    <small>Este processo pode levar alguns instantes. Por favor, não feche esta página.</small>
</div>

<div class="editor-container">
    <aside class="editor-sidebar">
        <header class="editor-header">
            <div class="header-content">
                <div class="header-icon"><i class="fas fa-magic"></i></div>
                <div class="header-text">
                    <h1>Gerador de Vídeos IA</h1>
                    <p>Crie um vídeo profissional em segundos.</p>
                </div>
            </div>
        </header>

        <form class="video-form" method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            {{ form.video_base_id }}
            <div class="video-form-wrapper">
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                    </div>
                {% endif %}

                <div class="panel-navigation">
                    <div class="nav-steps">
                        <div class="step" data-step="0"><div class="step-number">1</div><div class="step-info"><span>Tipo</span></div></div>
                        <div class="step" data-step="1"><div class="step-number">2</div><div class="step-info"><span>Conteúdo</span></div></div>
                        <div class="step" data-step="2"><div class="step-number">3</div><div class="step-info"><span>Estilo</span></div></div>
                        <div class="step" data-step="3" data-step-conditional="narrador,vendedor"><div class="step-number">4</div><div class="step-info"><span>Voz</span></div></div>
                        <div class="step" data-step="4"><div class="step-number">5</div><div class="step-info"><span>Mídia</span></div></div>
                    </div>
                    <div class="progress-bar"><div class="progress-fill"></div></div>
                </div>

                <div class="panel-content">
                    <div class="form-step" data-step-content="0">
                        <div class="step-header">
                            <h3><i class="fas fa-stream"></i> Qual o tipo de conteúdo?</h3>
                            <p>Escolha como o texto principal do seu vídeo será gerado.</p>
                        </div>
                        <div class="option-cards">
                            {% for radio in form.tipo_conteudo %}
                            <label class="option-card">
                                {{ radio.tag }}
                                <div class="card-content">
                                    {% if forloop.counter == 1 %}<div class="card-icon"><i class="fas fa-microphone-alt"></i></div><div class="card-info"><h4>Texto com Narração</h4><p>Gera uma voz a partir do seu texto.</p></div>{% endif %}
                                    {% if forloop.counter == 2 %}<div class="card-icon"><i class="fas fa-font"></i></div><div class="card-info"><h4>Texto Estático</h4><p>Exibe um texto fixo na tela.</p></div>{% endif %}
                                    {% if forloop.counter == 3 %}<div class="card-icon"><i class="fas fa-upload"></i></div><div class="card-info"><h4>Vendedor (Upload)</h4><p>Use seu próprio vídeo com narração.</p></div>{% endif %}
                                    <div class="card-check"><i class="fas fa-check-circle"></i></div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-step" data-step-content="1">
                         <div class="secao-conteudo" data-content-type="texto">
                            <div class="step-header"><h3><i class="fas fa-paragraph"></i> Conteúdo do Texto Estático</h3></div>
                            <div class="form-field" id="field-texto-overlay">{{ form.texto_overlay.label_tag }} {{ form.texto_overlay }}</div>
                            <div class="form-field" id="field-duracao-segundos">{{ form.duracao_segundos.label_tag }} {{ form.duracao_segundos }} <div class="field-tip">{{ form.duracao_segundos.help_text }}</div></div>
                        </div>
                        <div class="secao-conteudo" data-content-type="narrador,vendedor">
                            <div class="step-header"><h3><i class="fas fa-comment-dots"></i> Conteúdo da Narração</h3></div>
                            <div class="form-field" id="field-narrador-texto">{{ form.narrador_texto.label_tag }} {{ form.narrador_texto }}</div>
                            <div class="text-counter-wrapper">
                                <div class="estimativa-narracao"><i class="fas fa-clock"></i> Digite para ver a estimativa</div>
                                <div class="text-counter">0/1500</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-step" data-step-content="2">
                        <div class="step-header"><h3><i class="fas fa-palette"></i> Estilo do Texto</h3><p>Personalize a aparência do texto na tela.</p></div>
                        <div class="form-field">
                            {{ form.posicao_texto.label_tag }}
                            <div class="radio-group">
                                {% for radio in form.posicao_texto %}
                                <label class="radio-option">
                                    {{ radio.tag }}
                                    <span class="custom-radio"><span class="inner-circle"></span></span>
                                    <span class="option-label">{{ radio.choice_label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">{{ form.cor_da_fonte.label_tag }} {{ form.cor_da_fonte }}</div>
                            <div class="form-field">{{ form.cor_destaque_legenda.label_tag }} {{ form.cor_destaque_legenda }}</div>
                            <div class="form-field">{{ form.texto_fonte.label_tag }} {{ form.texto_fonte }}</div>
                            <div class="form-field">{{ form.texto_tamanho.label_tag }} {{ form.texto_tamanho }}</div>
                        </div>
                        <div class="form-field"><label>Formatos:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-option">{{ form.texto_negrito }}<span class="checkbox-box"><i class="fas fa-check checkmark"></i></span><span class="option-title">Negrito</span></label>
                                <label class="checkbox-option">{{ form.texto_sublinhado }}<span class="checkbox-box"><i class="fas fa-check checkmark"></i></span><span class="option-title">Sublinhado</span></label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-step" data-step-content="3" data-step-conditional="narrador,vendedor">
                        <div class="step-header"><h3><i class="fas fa-volume-up"></i> Opções da Voz</h3><p>Ajuste os detalhes da narração.</p></div>
                        <div class="form-field">{{ form.narrador_voz.label_tag }}
                            <div class="input-group">{{ form.narrador_voz }}<button type="button" class="btn btn-secondary play-voice-preview-btn"><i class="fas fa-play"></i> Ouvir</button></div>
                        </div>
                        <div class="form-field">{{ form.narrador_velocidade.label_tag }} {{ form.narrador_velocidade }}</div>
                        <div class="form-field">
                            <label class="form-check-wrapper large">{{ form.legenda_sincronizada }}
                                <div class="form-check-info">
                                    <span class="form-check-title">Legenda Sincronizada</span>
                                    <span class="form-check-desc">{{ form.legenda_sincronizada.help_text }}</span>
                                </div>
                                <div class="toggle-switch"></div>
                            </label>
                        </div>
                    </div>

                    <div class="form-step" data-step-content="4">
                        <div class="step-header"><h3><i class="fas fa-photo-video"></i> Mídia de Fundo e Encerramento</h3></div>
                        <div class="form-field" id="field-categoria-video">{{ form.categoria_video.label_tag }} {{ form.categoria_video }}</div>
                        <div class="form-field" id="video-gallery-container" style="display: none;">
                            <label>Escolha um Vídeo:</label>
                            <div id="video-gallery" class="video-gallery">
                                <!-- Videos will be populated here by JavaScript -->
                            </div>
                        </div>
                        <div class="form-field" id="field-video-upload" style="display: none;">
                            <label for="{{ form.video_upload.id_for_label }}" class="custom-file-upload">
                                {{ form.video_upload }}
                                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                <div class="upload-text" id="upload-text-label">Clique para escolher um vídeo</div>
                                <div class="upload-hint">MP4, MOV, AVI, etc.</div>
                            </label>
                        </div>
                        <div class="form-field">{{ form.categoria_musica.label_tag }} {{ form.categoria_musica }}</div>
                        <div class="form-field">{{ form.volume_musica.label_tag }} {{ form.volume_musica }}</div>
                        <div class="form-field">
                            <label class="form-check-wrapper large">
                                {{ form.loop_video }}
                                <div class="form-check-info"><span class="form-check-title">{{ form.loop_video.label }}</span></div>
                                <div class="toggle-switch"></div>
                            </label>
                        </div>
                        <div class="form-field">{{ form.texto_tela_final.label_tag }}{{ form.texto_tela_final }}</div>
                    </div>
                </div>

                <div class="panel-actions">
                    <button type="button" class="btn btn-outline prev-step-btn" style="display: none;"><i class="fas fa-arrow-left"></i> Voltar</button>
                    <button type="button" class="btn btn-primary next-step-btn">Avançar <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div class="global-actions">
                <button type="submit" class="btn btn-primary btn-large btn-full">Gerar Vídeo <i class="fas fa-rocket"></i></button>
            </div>
        </form>
    </aside>

    <main class="editor-main-content">
        <div class="preview-area">
            <div class="preview-wrapper">
                <div class="preview-placeholder active">
                    <i class="fas fa-film"></i>
                    <h2>Preview do Vídeo</h2>
                    <p>Suas escolhas aparecerão aqui em tempo real.</p>
                </div>
                <div class="video-preview">
                    <video id="preview-video-element" class="video-element" muted loop playsinline></video>
                    <div id="preview-text-overlay" class="text-overlay"></div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}


{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENTOS DO DOM ---
    const form = document.querySelector('.video-form');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Preview
    const previewPlaceholder = document.querySelector('.preview-placeholder');
    const videoElement = document.getElementById('preview-video-element');
    const textOverlay = document.getElementById('preview-text-overlay');
    const previewWrapper = document.querySelector('.preview-wrapper');

    // Campos do formulário que afetam o preview
    const inputs = {
        tipoConteudo: form.querySelectorAll('input[name="tipo_conteudo"]'),
        textoOverlay: form.querySelector('[name="texto_overlay"]'),
        narradorTexto: form.querySelector('[name="narrador_texto"]'),
        posicaoTexto: form.querySelectorAll('input[name="posicao_texto"]'),
        corDaFonte: form.querySelector('select[name="cor_da_fonte"]'),
        textoFonte: form.querySelector('select[name="texto_fonte"]'),
        textoTamanho: form.querySelector('input[name="texto_tamanho"]'),
        textoNegrito: form.querySelector('input[name="texto_negrito"]'),
        textoSublinhado: form.querySelector('input[name="texto_sublinhado"]'),
        categoriaVideo: form.querySelector('select[name="categoria_video"]'),
        videoBaseId: form.querySelector('[name="video_base_id"]'),
        videoUpload: form.querySelector('input[name="video_upload"]'),
    };
    
    // --- LÓGICA DO PREVIEW EM TEMPO REAL ---

    function updatePreview() {
        // 1. Atualiza o texto
        const tipo = form.querySelector('input[name="tipo_conteudo"]:checked')?.value;
        let texto = '';
        if (tipo === 'texto') {
            texto = inputs.textoOverlay.value;
        }
        // O texto do narrador não é exibido na pré-visualização para evitar quebra de layout.
        textOverlay.innerText = texto;

        // 2. Atualiza estilos do texto com escala
        const finalVideoWidth = 1080; // Largura do vídeo final em pixels
        const previewWidth = previewWrapper.getBoundingClientRect().width;
        const scaleFactor = previewWidth / finalVideoWidth;
        
        const originalFontSize = parseInt(inputs.textoTamanho.value, 10);
        const scaledFontSize = originalFontSize * scaleFactor;

        textOverlay.style.color = inputs.corDaFonte.value;
        textOverlay.style.fontFamily = `'${inputs.textoFonte.options[inputs.textoFonte.selectedIndex].text}', sans-serif`;
        textOverlay.style.fontSize = `${scaledFontSize}px`;
        textOverlay.style.fontWeight = inputs.textoNegrito.checked ? 'bold' : 'normal';
        textOverlay.style.textDecoration = inputs.textoSublinhado.checked ? 'underline' : 'none';
        
        // 3. Atualiza posição do texto
        const posicao = form.querySelector('input[name="posicao_texto"]:checked')?.value;
        textOverlay.classList.toggle('align-center', posicao === 'centro');
        textOverlay.classList.toggle('align-bottom', posicao === 'inferior');
    }

    const videoGalleryContainer = document.getElementById('video-gallery-container');
    const videoGallery = document.getElementById('video-gallery');

    async function updatePreviewVideo() {
        const tipo = form.querySelector('input[name="tipo_conteudo"]:checked')?.value;
        let videoUrl = null;

        if (tipo === 'vendedor') {
            videoGalleryContainer.style.display = 'none';
            const file = inputs.videoUpload.files[0];
            if (file) {
                videoUrl = URL.createObjectURL(file);
            }
        } else {
            const categoriaId = inputs.categoriaVideo.value;
            videoGallery.innerHTML = ''; // Limpa a galeria
            inputs.videoBaseId.value = ''; // Limpa o video selecionado

            if (!categoriaId) {
                videoGalleryContainer.style.display = 'none';
                videoElement.src = '';
                videoElement.classList.remove('visible');
                previewPlaceholder.classList.remove('hidden');
                return;
            }

            videoGalleryContainer.style.display = 'block';
            videoGallery.innerHTML = '<p>Carregando vídeos...</p>';
            
            try {
                const response = await fetch(`/api/videos-por-categoria/${categoriaId}/`);
                if (!response.ok) throw new Error('Falha ao buscar vídeos da categoria');
                const data = await response.json();
                console.log('Videos data:', data); // DEBUG: Mostra os dados recebidos
                
                videoGallery.innerHTML = ''; // Limpa a mensagem de carregando

                if (data.videos && data.videos.length > 0) {
                    // Popula a galeria
                    data.videos.forEach(video => {
                        const item = document.createElement('div');
                        item.classList.add('video-gallery-item');
                        item.dataset.videoId = video.id;
                        item.dataset.videoUrl = video.url;

                        const videoThumb = document.createElement('video');
                        videoThumb.src = video.url + '#t=0.5';
                        videoThumb.preload = 'metadata';
                        videoThumb.muted = true;

                        const title = document.createElement('div');
                        title.classList.add('video-title');
                        title.textContent = video.titulo;

                        item.appendChild(videoThumb);
                        item.appendChild(title);
                        videoGallery.appendChild(item);

                        item.addEventListener('click', () => {
                            document.querySelectorAll('.video-gallery-item.selected').forEach(el => el.classList.remove('selected'));
                            item.classList.add('selected');
                            inputs.videoBaseId.value = video.id;
                            
                            videoUrl = video.url;
                            if (videoUrl) {
                                previewPlaceholder.classList.add('hidden');
                                videoElement.src = videoUrl;
                                videoElement.load();
                                videoElement.play().catch(e => console.log("Autoplay bloqueado."));
                                videoElement.classList.add('visible');
                            }
                        });
                    });

                    // Seleciona o primeiro video por padrão
                    const firstVideoItem = videoGallery.querySelector('.video-gallery-item');
                    if (firstVideoItem) {
                        firstVideoItem.click();
                    }

                } else {
                    videoGallery.innerHTML = '<p>Nenhum vídeo encontrado para esta categoria.</p>';
                }

            } catch (error) {
                console.error("Erro ao buscar galeria de vídeos:", error);
                videoGallery.innerHTML = '<p>Erro ao carregar vídeos.</p>';
            }
        }
        
        if (tipo === 'vendedor' && videoUrl) {
            previewPlaceholder.classList.add('hidden');
            videoElement.src = videoUrl;
            videoElement.load();
            videoElement.play().catch(e => console.log("Autoplay bloqueado."));
            videoElement.classList.add('visible');
        }
    }

    // Adiciona event listeners para todos os campos relevantes
    Object.values(inputs).forEach(inputOrNodeList => {
        const elements = NodeList.prototype.isPrototypeOf(inputOrNodeList) ? Array.from(inputOrNodeList) : [inputOrNodeList];
        elements.forEach(el => {
            if (el) { // Verifica se o elemento existe
                const eventType = (el.type === 'select-one' || el.type === 'radio' || el.type === 'checkbox') ? 'change' : 'input';
                el.addEventListener(eventType, updatePreview);
            }
        });
    });

    inputs.categoriaVideo.addEventListener('change', updatePreviewVideo);
    inputs.videoUpload.addEventListener('change', updatePreviewVideo);
    inputs.tipoConteudo.forEach(radio => radio.addEventListener('change', updatePreviewVideo));


    // --- LÓGICA DE NAVEGAÇÃO E VISIBILIDADE (Reaproveitada e adaptada) ---
    const steps = form.querySelectorAll('.nav-steps .step');
    const stepContents = form.querySelectorAll('.form-step');
    const prevBtn = form.querySelector('.prev-step-btn');
    const nextBtn = form.querySelector('.next-step-btn');
    const progressBar = form.querySelector('.progress-fill');
    
    let state = { currentStep: 0, availableSteps: [] };

    const updateAvailableSteps = () => {
        const selectedType = form.querySelector('input[name="tipo_conteudo"]:checked')?.value;
        state.availableSteps = [];
        steps.forEach(step => {
            const stepIndex = parseInt(step.dataset.step);
            const condition = step.dataset.stepConditional;
            if (!condition || condition.split(',').includes(selectedType)) {
                step.style.display = 'flex';
                state.availableSteps.push(stepIndex);
            } else {
                step.style.display = 'none';
            }
        });
    };
    
    const goToStep = (stepIndex) => {
        state.currentStep = stepIndex;
        const currentPos = state.availableSteps.indexOf(stepIndex);
        
        steps.forEach(s => {
            s.classList.toggle('active', parseInt(s.dataset.step) === stepIndex);
            s.classList.toggle('completed', parseInt(s.dataset.step) < stepIndex);
        });
        stepContents.forEach(c => c.classList.toggle('active', parseInt(c.dataset.stepContent) === stepIndex));
        
        progressBar.style.width = `${((currentPos) / (state.availableSteps.length -1)) * 100}%`;
        prevBtn.style.display = currentPos > 0 ? 'flex' : 'none';
        nextBtn.style.display = currentPos < state.availableSteps.length - 1 ? 'flex' : 'none';
    };
    
    function toggleFieldsByContentType(selectedType) {
        form.querySelector('[data-content-type="texto"]').style.display = selectedType === 'texto' ? 'block' : 'none';
        form.querySelector('[data-content-type="narrador,vendedor"]').style.display = (selectedType === 'narrador' || selectedType === 'vendedor') ? 'block' : 'none';
        form.querySelector('#field-video-upload').style.display = selectedType === 'vendedor' ? 'block' : 'none';
        form.querySelector('#field-categoria-video').style.display = selectedType === 'vendedor' ? 'none' : 'block';
    }

    inputs.tipoConteudo.forEach(radio => radio.addEventListener('change', (e) => {
        toggleFieldsByContentType(e.target.value);
        updateAvailableSteps();
        if (!state.availableSteps.includes(state.currentStep)) {
             goToStep(state.availableSteps[0]);
        } else {
             goToStep(state.currentStep);
        }
    }));
    
    prevBtn.addEventListener('click', () => {
        const currentPos = state.availableSteps.indexOf(state.currentStep);
        if (currentPos > 0) goToStep(state.availableSteps[currentPos - 1]);
    });
    nextBtn.addEventListener('click', () => {
        const currentPos = state.availableSteps.indexOf(state.currentStep);
        if (currentPos < state.availableSteps.length - 1) goToStep(state.availableSteps[currentPos + 1]);
    });
    steps.forEach(step => step.addEventListener('click', () => {
        const stepIndex = parseInt(step.dataset.step);
        if (state.availableSteps.includes(stepIndex)) goToStep(stepIndex);
    }));

    // --- OUTRAS FUNCIONALIDADES (Reaproveitadas) ---
    form.addEventListener('submit', function() {
        loadingOverlay.classList.add('visible');
        form.querySelector('button[type="submit"]').disabled = true;
    });

    const textoNarracao = inputs.narradorTexto;
    const selectVelocidade = form.querySelector('[name="narrador_velocidade"]');
    const estimativaElement = form.querySelector('.estimativa-narracao');
    const counterElement = form.querySelector('.text-counter');
    const uploadTextLabel = form.querySelector('#upload-text-label');

    const calcularEstimativa = async () => {
        const texto = textoNarracao.value;
        counterElement.textContent = `${texto.length}/1500`;
        if (!texto.trim()) {
            estimativaElement.innerHTML = '<i class="fas fa-clock"></i> Digite para ver a estimativa';
            return;
        }
        const velocidade = parseInt(selectVelocidade.value, 10) || 100;
        try {
            const response = await fetch("{% url 'estimativa_narracao' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({ texto, velocidade })
            });
            const data = await response.json();
            estimativaElement.innerHTML = `<i class="fas fa-clock"></i> Estimativa: ${data.duracao_segundos.toFixed(1)}s`;
        } catch (error) { console.error('Erro na estimativa:', error); }
    };
    textoNarracao.addEventListener('input', calcularEstimativa);
    selectVelocidade.addEventListener('change', calcularEstimativa);

    inputs.videoUpload.addEventListener('change', function() {
        uploadTextLabel.textContent = this.files.length > 0 ? this.files[0].name : 'Clique para escolher um vídeo';
    });

    // --- INICIALIZAÇÃO ---
    const checkedRadio = form.querySelector('input[name="tipo_conteudo"]:checked') || inputs.tipoConteudo[0];
    if (checkedRadio) {
        checkedRadio.checked = true;
        toggleFieldsByContentType(checkedRadio.value);
    }
    updateAvailableSteps();
    goToStep(0);
    updatePreview();
});
</script>
{% endblock %}