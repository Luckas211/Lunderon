{% extends 'core/base.html' %}
{% load static %}

{% block title %}Gerador de Vídeos - LUNDERON{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'core/css/gerador-profissional.css' %}">
    <style>
        /* Estilos do Box do Tipo de IA (Protegidos) */
        .ia-choice-container {
            margin-top: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(101, 91, 226, 0.03);
            border-radius: 8px;
            border: 1px dashed var(--color-primary);
        }
        .ia-choice-container label.main-label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--color-primary);
        }
        .radio-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .ia-card-option {
            display: flex !important;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .ia-card-option:hover {
            border-color: var(--color-primary);
            background: rgba(101, 91, 226, 0.05);
        }
        /* Esconde o rádio padrão, permitindo que a div customizada brilhe */
        .ia-card-option input[type="radio"] {
            display: none; 
        }
        /* Quando marcado, o CSS reflete a mudança visualmente */
        .ia-card-option input[type="radio"]:checked ~ .custom-radio .inner-circle {
            background-color: var(--color-primary);
            transform: scale(1);
        }
        .ia-card-option input[type="radio"]:checked ~ .option-label {
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block content %}
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p class="loading-text">Gerando seu vídeo com IA...</p>
    <small>Este processo pode levar alguns instantes. Por favor, não feche esta página.</small>
</div>

<div class="editor-container">
    <aside class="editor-sidebar">
        <header class="editor-header">
            <div class="header-content">
                <div class="header-icon"><i class="fas fa-magic"></i></div>
                <div class="header-text">
                    <h1>Gerador de Vídeos com IA</h1>
                    <p>Crie vídeos incríveis com narração, legendas e música de fundo em poucos cliques.</p>
                </div>
            </div>
        </header>

        <form class="video-form" method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            {{ form.video_base_id }}
            <div class="video-form-wrapper">
                <div id="form-notifications" style="margin-bottom: 1rem;"></div>
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                    </div>
                {% endif %}

                <div class="panel-navigation">
                    <div class="nav-steps">
                        <div class="step" data-step="0"><div class="step-number">1</div><div class="step-info"><span>Tipo</span></div></div>
                        <div class="step" data-step="1"><div class="step-number">2</div><div class="step-info"><span>Conteúdo</span></div></div>
                        <div class="step" data-step="2"><div class="step-number">3</div><div class="step-info"><span>Estilo</span></div></div>
                        <div class="step" data-step="3" data-step-conditional="narrador,vendedor"><div class="step-number">4</div><div class="step-info"><span>Voz</span></div></div>
                        <div class="step" data-step="4"><div class="step-number">5</div><div class="step-info"><span>Mídia</span></div></div>
                    </div>
                    <div class="progress-bar"><div class="progress-fill"></div></div>
                </div>

                <div class="panel-content">
                    <div class="form-step" data-step-content="0">
                        <div class="step-header">
                            <h3><i class="fas fa-stream"></i> Qual o tipo de vídeo que você quer criar?</h3>
                            <p>Escolha como o texto principal do seu vídeo será gerado.</p>
                        </div>
                        <div class="option-cards">
                            {% for radio in form.tipo_conteudo %}
                            <label class="option-card">
                                {{ radio.tag }}
                                <div class="card-content">
                                    {% if forloop.counter == 1 %}<div class="card-icon"><i class="fas fa-microphone-alt"></i></div><div class="card-info"><h4>Vídeo com Narração</h4><p>Gere uma voz a partir de um texto e adicione um vídeo de fundo (ou IA).</p></div>{% endif %}
                                    {% if forloop.counter == 2 %}<div class="card-icon"><i class="fas fa-font"></i></div><div class="card-info"><h4>Vídeo com Texto</h4><p>Crie um vídeo com um texto estático e um fundo.</p></div>{% endif %}
                                    {% if forloop.counter == 3 %}<div class="card-icon"><i class="fas fa-upload"></i></div><div class="card-info"><h4>Vídeo de Vendas</h4><p>Envie seu próprio vídeo e adicione uma narração para criar um anúncio.</p></div>{% endif %}
                                    <div class="card-check"><i class="fas fa-check-circle"></i></div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-step" data-step-content="1">
                         <div class="secao-conteudo" data-content-type="texto">
                            <div class="step-header"><h3><i class="fas fa-paragraph"></i> Conteúdo do Texto Estático</h3></div>
                            <div class="form-field" id="field-texto-overlay">
                                {{ form.texto_overlay.label_tag }} {{ form.texto_overlay }}
                                <div id="texto-overlay-info-box" class="info-box" style="margin-top: 10px;">
                                    <div class="info-box-line">
                                        <i class="fas fa-keyboard"></i>
                                        <span>Contagem: <strong id="current-chars-overlay">0</strong> / <strong>250</strong> caracteres</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-field" id="field-duracao-segundos">{{ form.duracao_segundos.label_tag }} {{ form.duracao_segundos }} <div class="field-tip">{{ form.duracao_segundos.help_text }}</div></div>
                        </div>
                        <div class="secao-conteudo" data-content-type="narrador,vendedor">
                            <div class="step-header"><h3><i class="fas fa-comment-dots"></i> Conteúdo da Narração</h3></div>
                            <div class="form-field" id="field-narrador-texto">{{ form.narrador_texto.label_tag }} {{ form.narrador_texto }}</div>
                            <div id="narration-info-box" class="info-box">
                                {% with initial_speed=form.narrador_velocidade.initial|default:'100'|add:0 %}
                                <div class="info-box-line">
                                    <i class="fas fa-keyboard"></i>
                                    <span>Contagem: <strong id="current-chars">0</strong> / 
                                    <strong id="char-limit">
                                        {% if initial_speed <= 85 %}2000{% elif initial_speed <= 100 %}2600{% else %}3200{% endif %}
                                    </strong> caracteres</span>
                                </div>
                                <div class="info-box-line">
                                    <i class="fas fa-tachometer-alt"></i>
                                    <span id="speed-info">Velocidade: <strong id="speed-name">
                                        {% if initial_speed <= 85 %}Lenta{% elif initial_speed <= 100 %}Normal{% else %}Rápida{% endif %}
                                    </strong></span>
                                </div>
                                {% endwith %}
                                <div class="info-box-line">
                                    <i class="fas fa-clock"></i>
                                    <span id="time-estimation">Digite para ver a estimativa</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-step" data-step-content="2">
                        <div class="step-header"><h3><i class="fas fa-palette"></i> Estilo do Texto</h3><p>Personalize a aparência do texto na tela.</p></div>
                        <div class="form-field">
                            {{ form.posicao_texto.label_tag }}
                            <div class="radio-group">
                                {% for radio in form.posicao_texto %}
                                <label class="radio-option">
                                    {{ radio.tag }}
                                    <span class="custom-radio"><span class="inner-circle"></span></span>
                                    <span class="option-label">{{ radio.choice_label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <div class="label-wrapper">
                                    {{ form.cor_da_fonte.label_tag }}
                                    <div class="tooltip"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltiptext">Define a cor principal do texto ou da legenda que aparecerá no vídeo.</span></div>
                                </div>
                                {{ form.cor_da_fonte }}
                            </div>
                            <div class="form-field">
                                <div class="label-wrapper">
                                    {{ form.cor_destaque_legenda.label_tag }}
                                    <div class="tooltip"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltiptext">Apenas no modo "Legenda Sincronizada". Define a cor da palavra que está sendo falada (efeito karaokê).</span></div>
                                </div>
                                {{ form.cor_destaque_legenda }}
                            </div>
                            <div class="form-field">
                                <div class="label-wrapper">
                                    {{ form.texto_fonte.label_tag }}
                                    <div class="tooltip"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltiptext">Escolha a família da fonte para o texto. Fontes diferentes causam grande impacto visual.</span></div>
                                </div>
                                {{ form.texto_fonte }}
                            </div>
                            <div class="form-field">
                                <div class="label-wrapper">
                                    {{ form.texto_tamanho.label_tag }}
                                    <div class="tooltip"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltiptext">Tamanho inicial da fonte. O sistema pode reduzir o tamanho automaticamente para que textos longos caibam na tela.</span></div>
                                </div>
                                {{ form.texto_tamanho }}
                            </div>
                        </div>
                        <div class="form-field"><label>Formatos:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-option">{{ form.texto_negrito }}<span class="checkbox-box"><i class="fas fa-check checkmark"></i></span><span class="option-title">Negrito</span></label>
                                <label class="checkbox-option">{{ form.texto_sublinhado }}<span class="checkbox-box"><i class="fas fa-check checkmark"></i></span><span class="option-title">Sublinhado</span></label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-step" data-step-content="3" data-step-conditional="narrador,vendedor">
                        <div class="step-header"><h3><i class="fas fa-volume-up"></i> Opções da Voz</h3><p>Ajuste os detalhes da narração.</p></div>
                        <div class="form-field">{{ form.narrador_voz.label_tag }}
                            <div class="input-group">{{ form.narrador_voz }}<button type="button" class="btn btn-secondary play-voice-preview-btn"><i class="fas fa-play"></i> Ouvir</button></div>
                        </div>
                        <div class="form-field">{{ form.narrador_velocidade.label_tag }} {{ form.narrador_velocidade }}</div>
                        <div class="form-field">
                            <label class="form-check-wrapper large">{{ form.legenda_sincronizada }}
                                <div class="form-check-info">
                                    <span class="form-check-title">Legenda Sincronizada</span>
                                    <span class="form-check-desc">{{ form.legenda_sincronizada.help_text }}</span>
                                </div>
                                <div class="toggle-switch"></div>
                            </label>
                        </div>
                    </div>

                    <div class="form-step" data-step-content="4">
                        <div class="step-header"><h3><i class="fas fa-photo-video"></i> Mídia de Fundo e Encerramento</h3></div>
                        
                        <div class="form-field" id="field-gerar-fundo-ia" style="display: none; margin-bottom: 20px;">
                            <label class="form-check-wrapper large" style="border: 2px solid var(--color-primary); padding: 15px; border-radius: 10px; cursor: pointer; background: rgba(101, 91, 226, 0.05);">
                                {{ form.gerar_fundo_ia }}
                                <div class="form-check-info">
                                    <span class="form-check-title" style="font-weight: bold; font-size: 1.1em; color: var(--color-primary);">
                                        <i class="fas fa-robot"></i> Gerar Fundo Dinâmico
                                    </span>
                                    <span class="form-check-desc">Use Inteligência Artificial para escolher ou criar um fundo exclusivo.</span>
                                </div>
                                <div class="toggle-switch"></div>
                            </label>
                        </div>

                        <div id="field-tipo-visual-ia" class="ia-choice-container" style="display: none;">
                            <label class="main-label">Selecione o Motor Criativo:</label>
                            <div class="radio-group-vertical">
                                {% for radio in form.tipo_visual_ia %}
                                <label class="radio-option ia-card-option">
                                    {{ radio.tag }}
                                    <span class="custom-radio" style="margin-right: 15px;"><span class="inner-circle"></span></span>
                                    <span class="option-label" style="font-size: 1.1em;">
                                        {% if forloop.counter == 1 %}
                                            <i class="fas fa-image" style="color:var(--color-primary); margin-right: 8px;"></i>
                                        {% else %}
                                            <i class="fas fa-video" style="color:#FFD700; margin-right: 8px;"></i>
                                        {% endif %}
                                        {{ radio.choice_label }}
                                    </span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="form-field" id="field-categoria-video">{{ form.categoria_video.label_tag }} {{ form.categoria_video }}</div>
                        <div class="form-field" id="video-gallery-container" style="display: none;">
                            <label>Escolha um Vídeo (Se IA estiver desmarcada):</label>
                            <div id="video-gallery" class="video-gallery"></div>
                        </div>

                        <div class="form-field" id="field-video-upload" style="display: none;">
                            <label for="{{ form.video_upload.id_for_label }}" class="custom-file-upload">
                                {{ form.video_upload }}
                                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                <div class="upload-text" id="upload-text-label">Clique para escolher um vídeo</div>
                                <div class="upload-hint">MP4, MOV, AVI, etc.</div>
                            </label>
                        </div>

                        <div class="form-field">{{ form.categoria_musica.label_tag }} {{ form.categoria_musica }}</div>
                        <div class="form-field">{{ form.volume_musica.label_tag }} {{ form.volume_musica }}</div>
                        <div class="form-field">
                            <label class="form-check-wrapper large">
                                {{ form.loop_video }}
                                <div class="form-check-info"><span class="form-check-title">{{ form.loop_video.label }}</span></div>
                                <div class="toggle-switch"></div>
                            </label>
                        </div>
                        <div class="form-field">{{ form.texto_tela_final.label_tag }}{{ form.texto_tela_final }}</div>
                    </div>
                </div>

                <div class="panel-actions">
                    <button type="button" class="btn btn-outline prev-step-btn" style="display: none;"><i class="fas fa-arrow-left"></i> Voltar</button>
                    <button type="button" class="btn btn-primary next-step-btn">Avançar <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div class="global-actions">
                <button type="submit" class="btn btn-primary btn-large btn-full">Gerar Vídeo <i class="fas fa-rocket"></i></button>
            </div>
        </form>
    </aside>

    <main class="editor-main-content">
        <div class="preview-area">
            <div class="preview-wrapper">
                <div class="preview-placeholder active">
                    <i class="fas fa-film"></i>
                    <h2>Preview do Vídeo</h2>
                    <p>Suas escolhas aparecerão aqui em tempo real.</p>
                </div>
                <div class="video-preview">
                    <video id="preview-video-element" class="video-element" muted loop playsinline></video>
                    <div id="preview-text-overlay" class="text-overlay"></div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}


{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.video-form');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Preview
    const previewPlaceholder = document.querySelector('.preview-placeholder');
    const videoElement = document.getElementById('preview-video-element');
    const textOverlay = document.getElementById('preview-text-overlay');
    const previewWrapper = document.querySelector('.preview-wrapper');

    // Input Pointers Robustos
    const inputs = {
        tipoConteudo: form.querySelectorAll('input[name="tipo_conteudo"]'),
        textoOverlay: form.querySelector('[name="texto_overlay"]'),
        narradorTexto: form.querySelector('[name="narrador_texto"]'),
        posicaoTexto: form.querySelectorAll('input[name="posicao_texto"]'),
        corDaFonte: form.querySelector('select[name="cor_da_fonte"]'),
        textoFonte: form.querySelector('select[name="texto_fonte"]'),
        textoTamanho: form.querySelector('select[name="texto_tamanho"]'),
        textoNegrito: form.querySelector('input[name="texto_negrito"]'),
        textoSublinhado: form.querySelector('input[name="texto_sublinhado"]'),
        categoriaVideo: form.querySelector('select[name="categoria_video"]'),
        videoBaseId: form.querySelector('[name="video_base_id"]'),
        videoUpload: form.querySelector('input[name="video_upload"]'),
        gerarFundoIa: form.querySelector('input[name="gerar_fundo_ia"]'),
        tipoVisualIa: form.querySelectorAll('input[name="tipo_visual_ia"]')
    };

    const fieldGroups = {
        texto: form.querySelector('[data-content-type="texto"]'),
        narrador: form.querySelector('[data-content-type="narrador,vendedor"]'),
        upload: document.getElementById('field-video-upload'),
        categoria: document.getElementById('field-categoria-video'),
        galeria: document.getElementById('video-gallery-container'),
        fundoIa: document.getElementById('field-gerar-fundo-ia'),
        tipoVisualIa: document.getElementById('field-tipo-visual-ia')
    };

    // =========================================================
    // NÚCLEO ÚNICO DE VISIBILIDADE (Evita conflitos)
    // =========================================================
    async function updateVisibility() {
        const tipo = form.querySelector('input[name="tipo_conteudo"]:checked')?.value || 'narrador';
        const checkboxIa = inputs.gerarFundoIa;
        const usarIA = checkboxIa && checkboxIa.checked;
        const modoVisualIa = form.querySelector('input[name="tipo_visual_ia"]:checked')?.value || 'imagem';

        // 1. Reseta TUDO
        Object.values(fieldGroups).forEach(group => {
            if (group) group.style.display = 'none';
        });

        // 2. Aplica as regras de exibição
        if (tipo === 'texto') {
            if (fieldGroups.texto) fieldGroups.texto.style.display = 'block';
            if (fieldGroups.categoria) fieldGroups.categoria.style.display = 'block';
            if (checkboxIa) checkboxIa.checked = false; 

        } else if (tipo === 'vendedor') {
            if (fieldGroups.narrador) fieldGroups.narrador.style.display = 'block';
            if (fieldGroups.upload) fieldGroups.upload.style.display = 'block';
            if (checkboxIa) checkboxIa.checked = false;

        } else if (tipo === 'narrador') {
            if (fieldGroups.narrador) fieldGroups.narrador.style.display = 'block';
            if (fieldGroups.fundoIa) fieldGroups.fundoIa.style.display = 'block';
            
            if (usarIA) {
                if (fieldGroups.tipoVisualIa) fieldGroups.tipoVisualIa.style.display = 'block';
            } else {
                if (fieldGroups.categoria) fieldGroups.categoria.style.display = 'block';
            }
        }

        updateAvailableSteps();

        // 3. Gerenciamento do Box de Preview
        let videoUrl = null;
        if (tipo === 'vendedor') {
            const file = inputs.videoUpload && inputs.videoUpload.files[0];
            if (file) videoUrl = URL.createObjectURL(file);
        }

        if (tipo === 'narrador' && usarIA) {
            inputs.videoBaseId.value = '';
            if (inputs.categoriaVideo) inputs.categoriaVideo.value = '';
            videoElement.src = '';
            videoElement.classList.remove('visible');
            
            if (modoVisualIa === 'video') {
                previewPlaceholder.innerHTML = '<i class="fas fa-video" style="color: #FFD700; font-size: 4rem; margin-bottom: 10px;"></i><h2>Vídeos Reais (Pexels)</h2><p style="padding: 0 20px;">Buscaremos automaticamente vídeos reais na internet para ilustrar sua história.</p>';
            } else {
                previewPlaceholder.innerHTML = '<i class="fas fa-robot" style="color: var(--color-primary); font-size: 4rem; margin-bottom: 10px;"></i><h2>Imagens IA (Flux)</h2><p style="padding: 0 20px;">Nossa IA criará ilustrações dinâmicas com efeito de zoom para acompanhar sua narração.</p>';
            }
            previewPlaceholder.classList.remove('hidden');

        } else if (tipo === 'vendedor' && videoUrl) {
            previewPlaceholder.classList.add('hidden');
            videoElement.src = videoUrl;
            videoElement.load();
            videoElement.play().catch(e => console.log("Autoplay bloqueado."));
            videoElement.classList.add('visible');

        } else if (tipo === 'texto' || (tipo === 'narrador' && !usarIA)) {
            const categoriaId = inputs.categoriaVideo ? inputs.categoriaVideo.value : null;
            if (categoriaId) {
                if (fieldGroups.galeria) fieldGroups.galeria.style.display = 'block';
                await fetchGallery(categoriaId);
            } else {
                if (fieldGroups.galeria) fieldGroups.galeria.style.display = 'none';
                videoElement.src = '';
                videoElement.classList.remove('visible');
                previewPlaceholder.innerHTML = '<i class="fas fa-film"></i><h2>Preview do Vídeo</h2><p>Suas escolhas aparecerão aqui em tempo real.</p>';
                previewPlaceholder.classList.remove('hidden');
            }
        }
    }

    // =========================================================
    // GALERIA, TEXTO E NAVEGAÇÃO
    // =========================================================
    async function fetchGallery(categoriaId) {
        const videoGallery = document.getElementById('video-gallery');
        videoGallery.innerHTML = '<p>Carregando vídeos...</p>';
        try {
            const response = await fetch(`/api/videos-por-categoria/${categoriaId}/`);
            if (!response.ok) throw new Error('Falha');
            const data = await response.json();
            videoGallery.innerHTML = ''; 

            if (data.videos && data.videos.length > 0) {
                data.videos.forEach(video => {
                    const item = document.createElement('div');
                    item.classList.add('video-gallery-item');
                    item.dataset.videoId = video.id;
                    item.dataset.videoUrl = video.url;

                    const videoThumb = document.createElement('video');
                    videoThumb.src = video.url;
                    videoThumb.preload = 'metadata';
                    videoThumb.muted = true;
                    videoThumb.playsInline = true;

                    const title = document.createElement('div');
                    title.classList.add('video-title');
                    title.textContent = video.titulo;

                    item.appendChild(videoThumb);
                    item.appendChild(title);
                    videoGallery.appendChild(item);

                    item.addEventListener('click', () => {
                        document.querySelectorAll('.video-gallery-item.selected').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                        inputs.videoBaseId.value = item.dataset.videoId;
                        const vUrl = item.dataset.videoUrl;
                        if (vUrl) {
                            previewPlaceholder.classList.add('hidden');
                            videoElement.src = vUrl;
                            videoElement.load();
                            videoElement.play().catch(e => console.log("Autoplay bloqueado."));
                            videoElement.classList.add('visible');
                        }
                    });
                });
                const firstVideoItem = videoGallery.querySelector('.video-gallery-item');
                if (firstVideoItem) firstVideoItem.click();
            } else {
                videoGallery.innerHTML = '<p>Nenhum vídeo encontrado.</p>';
            }
        } catch (error) {
            videoGallery.innerHTML = '<p>Erro ao carregar vídeos.</p>';
        }
    }

    function updatePreviewText() {
        const tipo = form.querySelector('input[name="tipo_conteudo"]:checked')?.value;
        let texto = '';
        if (tipo === 'texto') texto = inputs.textoOverlay.value;
        
        textOverlay.innerText = texto;
        const finalVideoWidth = 1080;
        const previewWidth = previewWrapper.getBoundingClientRect().width;
        const scaleFactor = previewWidth / finalVideoWidth;
        
        const originalFontSize = parseInt(inputs.textoTamanho.value, 10) || 70;
        textOverlay.style.fontFamily = `'${inputs.textoFonte.options[inputs.textoFonte.selectedIndex].text}', sans-serif`;
        textOverlay.style.fontSize = `${originalFontSize * scaleFactor}px`;
        textOverlay.style.fontWeight = inputs.textoNegrito.checked ? 'bold' : 'normal';
        textOverlay.style.textDecoration = inputs.textoSublinhado.checked ? 'underline' : 'none';
        
        const posicao = form.querySelector('input[name="posicao_texto"]:checked')?.value;
        textOverlay.classList.toggle('align-center', posicao === 'centro');
        textOverlay.classList.toggle('align-bottom', posicao === 'inferior');
    }

    ['texto_overlay', 'posicao_texto', 'cor_da_fonte', 'texto_fonte', 'texto_tamanho', 'texto_negrito', 'texto_sublinhado'].forEach(key => {
        const el = inputs[key];
        if(!el) return;
        const elements = NodeList.prototype.isPrototypeOf(el) ? Array.from(el) : [el];
        elements.forEach(node => {
            const eventType = (node.type === 'select-one' || node.type === 'radio' || node.type === 'checkbox') ? 'change' : 'input';
            node.addEventListener(eventType, updatePreviewText);
        });
    });

    if (inputs.textoOverlay && document.getElementById('current-chars-overlay')) {
        inputs.textoOverlay.addEventListener('input', () => {
            const len = inputs.textoOverlay.value.length;
            document.getElementById('current-chars-overlay').textContent = len;
            document.getElementById('texto-overlay-info-box').classList.toggle('limit-exceeded', len > 250);
        });
    }

    // LISTERNERS PRINCIPAIS DE MUDANÇA
    inputs.tipoConteudo.forEach(r => r.addEventListener('change', () => {
        updateVisibility();
        goToStep(state.availableSteps.includes(state.currentStep) ? state.currentStep : state.availableSteps[0]);
    }));
    
    if (inputs.gerarFundoIa) inputs.gerarFundoIa.addEventListener('change', updateVisibility);
    if (inputs.tipoVisualIa) inputs.tipoVisualIa.forEach(r => r.addEventListener('change', updateVisibility));
    if (inputs.categoriaVideo) inputs.categoriaVideo.addEventListener('change', updateVisibility);
    if (inputs.videoUpload) {
        inputs.videoUpload.addEventListener('change', function() {
            const label = document.getElementById('upload-text-label');
            if (label) label.textContent = this.files.length > 0 ? this.files[0].name : 'Clique para escolher um vídeo';
            updateVisibility();
        });
    }

    // NAVEGAÇÃO ENTRE PASSOS
    const steps = form.querySelectorAll('.nav-steps .step');
    const stepContents = form.querySelectorAll('.form-step');
    const prevBtn = form.querySelector('.prev-step-btn');
    const nextBtn = form.querySelector('.next-step-btn');
    const progressBar = form.querySelector('.progress-fill');
    let state = { currentStep: 0, availableSteps: [] };

    const updateAvailableSteps = () => {
        const selectedType = form.querySelector('input[name="tipo_conteudo"]:checked')?.value || 'narrador';
        state.availableSteps = [];
        steps.forEach(step => {
            const stepIndex = parseInt(step.dataset.step);
            const condition = step.dataset.stepConditional;
            if (!condition || condition.split(',').includes(selectedType)) {
                step.style.display = 'flex';
                state.availableSteps.push(stepIndex);
            } else {
                step.style.display = 'none';
            }
        });
    };
    
    const goToStep = (stepIndex) => {
        if (stepIndex > state.currentStep) {
            const currentStepContent = stepContents[state.currentStep];
            const inputsToValidate = Array.from(currentStepContent.querySelectorAll('input[required], select[required], textarea[required]'))
                                          .filter(el => el.offsetParent !== null);
            let isValid = true;
            inputsToValidate.forEach(input => {
                if (!input.value) { isValid = false; input.classList.add('is-invalid'); }
            });

            if (!isValid) {
                document.getElementById('form-notifications').innerHTML = `<div class="alert alert-danger">Por favor, preencha todos os campos obrigatórios.</div>`;
                return; 
            }
        }

        state.currentStep = stepIndex;
        const currentPos = state.availableSteps.indexOf(stepIndex);
        
        steps.forEach(s => {
            const sIndex = parseInt(s.dataset.step);
            s.classList.toggle('active', sIndex === stepIndex);
            s.classList.toggle('completed', state.availableSteps.indexOf(sIndex) < currentPos);
            s.classList.toggle('disabled', state.availableSteps.indexOf(sIndex) > currentPos);
        });
        stepContents.forEach(c => c.classList.toggle('active', parseInt(c.dataset.stepContent) === stepIndex));
        
        progressBar.style.width = `${((currentPos) / (state.availableSteps.length -1)) * 100}%`;
        prevBtn.style.display = currentPos > 0 ? 'flex' : 'none';
        nextBtn.style.display = currentPos < state.availableSteps.length - 1 ? 'flex' : 'none';
    };
    
    prevBtn.addEventListener('click', () => {
        const currentPos = state.availableSteps.indexOf(state.currentStep);
        if (currentPos > 0) goToStep(state.availableSteps[currentPos - 1]);
    });
    nextBtn.addEventListener('click', () => {
        const currentPos = state.availableSteps.indexOf(state.currentStep);
        if (currentPos < state.availableSteps.length - 1) goToStep(state.availableSteps[currentPos + 1]);
    });
    steps.forEach(step => step.addEventListener('click', () => {
        const stepIndex = parseInt(step.dataset.step);
        if (state.availableSteps.includes(stepIndex)) goToStep(stepIndex);
    }));

    form.addEventListener('submit', function() {
        loadingOverlay.classList.add('visible');
        form.querySelector('button[type="submit"]').disabled = true;
    });

    const textoNarracao = inputs.narradorTexto;
    const selectVelocidade = form.querySelector('[name="narrador_velocidade"]');
    const submitButton = form.querySelector('button[type="submit"]');

    const updateNarrationInfo = async () => {
        const texto = textoNarracao.value;
        const velocidade = parseInt(selectVelocidade.value, 10) || 100;
        let limite_chars, nome_velocidade;

        if (velocidade <= 85) { limite_chars = 2000; nome_velocidade = "Lenta"; } 
        else if (velocidade <= 100) { limite_chars = 2600; nome_velocidade = "Normal"; } 
        else { limite_chars = 3200; nome_velocidade = "Rápida"; }

        document.getElementById('current-chars').textContent = texto.length;
        document.getElementById('char-limit').textContent = limite_chars;
        document.getElementById('speed-info').innerHTML = `Velocidade: <strong>${nome_velocidade}</strong>`;

        const notificationDiv = document.getElementById('form-notifications');
        const box = document.getElementById('narration-info-box');
        
        if (texto.length > limite_chars) {
            box.classList.add('limit-exceeded');
            submitButton.disabled = true;
            notificationDiv.innerHTML = `<div class="alert alert-danger">Você excedeu o limite de ${limite_chars} caracteres!</div>`;
        } else {
            box.classList.remove('limit-exceeded');
            submitButton.disabled = false;
            notificationDiv.innerHTML = ``;
        }

        const timeEstimationSpan = document.getElementById('time-estimation');
        if (!texto.trim()) {
            timeEstimationSpan.textContent = 'Digite para ver a estimativa';
            return;
        }

        try {
            const response = await fetch("{% url 'estimativa_narracao' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({ texto, velocidade })
            });
            const data = await response.json();
            timeEstimationSpan.textContent = response.ok ? `Estimativa: ${data.duracao_segundos.toFixed(1)}s` : 'Erro na estimativa';
        } catch (error) {
            timeEstimationSpan.textContent = 'Erro na estimativa';
        }
    };

    if (textoNarracao && selectVelocidade) {
        textoNarracao.addEventListener('input', updateNarrationInfo);
        selectVelocidade.addEventListener('change', updateNarrationInfo);
    }

    const playVoicePreviewBtn = form.querySelector('.play-voice-preview-btn');
    if (playVoicePreviewBtn) {
        const narradorVozSelect = form.querySelector('select[name="narrador_voz"]');
        let audio = null;
        const originalButtonHTML = playVoicePreviewBtn.innerHTML;

        playVoicePreviewBtn.addEventListener('click', async () => {
            const selectedVoice = narradorVozSelect.value;
            const notificationDiv = document.getElementById('form-notifications');

            if (!selectedVoice) {
                notificationDiv.innerHTML = `<div class="alert alert-warning">Selecione uma voz primeiro.</div>`;
                return;
            }

            if (audio && !audio.paused) {
                audio.pause();
                audio.currentTime = 0;
                playVoicePreviewBtn.innerHTML = originalButtonHTML;
                audio = null;
                return;
            }

            playVoicePreviewBtn.disabled = true;
            playVoicePreviewBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

            try {
                const response = await fetch(`/api/preview-voz/${selectedVoice}/`, {
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                const data = await response.json();

                if (response.ok) {
                    audio = new Audio(data.url);
                    audio.addEventListener('play', () => {
                        playVoicePreviewBtn.innerHTML = `<i class="fas fa-pause"></i>`;
                        playVoicePreviewBtn.disabled = false;
                    });
                    audio.addEventListener('ended', () => {
                        playVoicePreviewBtn.innerHTML = originalButtonHTML;
                        audio = null;
                    });
                    audio.play().catch(e => {
                        notificationDiv.innerHTML = `<div class="alert alert-danger">Erro de reprodução.</div>`;
                        playVoicePreviewBtn.innerHTML = originalButtonHTML;
                        playVoicePreviewBtn.disabled = false;
                    });
                } else {
                    notificationDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    playVoicePreviewBtn.innerHTML = originalButtonHTML;
                    playVoicePreviewBtn.disabled = false;
                }
            } catch (error) {
                notificationDiv.innerHTML = `<div class="alert alert-danger">Erro de rede.</div>`;
                playVoicePreviewBtn.innerHTML = originalButtonHTML;
                playVoicePreviewBtn.disabled = false;
            }
        });
    }

    // INICIALIZAÇÃO
    const checkedRadio = form.querySelector('input[name="tipo_conteudo"]:checked') || inputs.tipoConteudo[0];
    if (checkedRadio) checkedRadio.checked = true;
    
    updateVisibility();
    updatePreviewText();
    updateNarrationInfo();
});
</script>
{% endblock %}