{% extends 'core/base.html' %}
{% load static %}

{% block title %}Editor de Cortes do YouTube - LUNDERON{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/editor_page.css' %}">
<style>
    /* Estilos específicos para a lista de segmentos, que agora é o controle principal */
</style>
{% endblock %}

{% block content %}
<div class="editor-layout">
    <aside class="editor-panel">
        <div class="panel-header">
            <i class="fas fa-cut"></i>
            <h2>Editor de Cortes</h2>
        </div>

        <form id="youtube-cutter-form" method="post" class="panel-form">
            {% csrf_token %}
            {% if form.errors %}
                <div class="alert alert-danger">
                    <strong>Por favor, corrija os erros abaixo:</strong>
                    {{ form.errors }}
                </div>
            {% endif %}
            
            <div class="form-step-wrapper">
                <div class="form-step active" data-step="1">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h3>Cole a URL do Vídeo</h3>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.youtube_url.id_for_label }}">URL do YouTube</label>
                        {{ form.youtube_url }}
                    </div>
                    <button type="button" id="analyze-btn" class="btn btn-primary btn-full">Analisar Vídeo</button>
                    <div class="form-text">Cole a URL completa para que nossa IA encontre os melhores momentos.</div>
                </div>

                <div class="form-step" data-step="2">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h3>Selecione os Cortes e Opções</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Segmentos Encontrados</label>
                        <div id="segments-list-container"></div>
                        <small class="form-text text-muted mt-2">Selecione os segmentos que deseja transformar em vídeos. Segmentos em vermelho são longos demais.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.categoria_musica.id_for_label }}">Música de Fundo</label>
                        {{ form.categoria_musica }}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_volume_musica">Volume da Música (%)</label>
                        <div class="range-slider-group">
                            <input type="range" name="volume_musica" value="20" class="form-range" min="0" max="100" id="id_volume_musica" oninput="this.nextElementSibling.value = this.value">
                            <output>20</output>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-check-wrapper">
                            <input type="checkbox" class="form-check-input" id="id_gerar_legendas" name="gerar_legendas">
                            <div class="form-check-info">
                                <span class="form-check-title">Gerar Legendas (IA)</span>
                                <small class="form-text">Ativa a transcrição automática do áudio para legendas.</small>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <input type="hidden" name="segments" id="id_segments">
            <div class="panel-footer">
                <div class="alert alert-info">
                    Você tem <strong>{{ videos_restantes }}</strong> vídeo(s) restante(s) no seu limite.
                </div>
                <button type="button" id="submit-btn" class="btn btn-primary btn-full btn-lg" disabled>Gerar Cortes Selecionados</button>
            </div>
        </form>
    </aside>

    <main class="editor-preview">
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <p class="loading-text">Analisando...</p>
        </div>
        
        <div id="preview-placeholder" class="preview-placeholder">
            <i class="fab fa-youtube"></i>
            <h3>Sua prévia aparecerá aqui</h3>
            <p>Cole uma URL e clique em "Analisar Vídeo" para começar.</p>
        </div>

        <div id="preview-content" class="preview-content">
            <div class="video-preview-wrapper">
                <div id="youtube-player"></div>
            </div>
            <div id="segments-error" class="alert alert-danger" style="display: none;"></div>
        </div>
    </main>
</div>
{% endblock %}


{% block scripts %}
{{ block.super }}
<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let currentVideoId;
let fetchedSegments = []; // Armazena os segmentos recebidos da análise
let activePreviewTimeout = null;

function onYouTubeIframeAPIReady() {
    player = new YT.Player('youtube-player', {
        height: '100%',
        width: '100%',
        playerVars: {
            'playsinline': 1,
            'controls': 0,
            'rel': 0,
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('youtube-cutter-form');
    const analyzeBtn = document.getElementById('analyze-btn');
    const submitBtn = document.getElementById('submit-btn');
    const youtubeUrlInput = document.getElementById('id_youtube_url');
    const segmentsListContainer = document.getElementById('segments-list-container');
    const segmentsError = document.getElementById('segments-error');
    const hiddenSegmentsInput = document.getElementById('id_segments');
    
    const previewPlaceholder = document.getElementById('preview-placeholder');
    const previewContent = document.getElementById('preview-content');
    
    const step1 = document.querySelector('.form-step[data-step="1"]');
    const step2 = document.querySelector('.form-step[data-step="2"]');
    const loadingOverlay = document.getElementById('loading-overlay');

    youtubeUrlInput.classList.add('form-input');
    document.getElementById('id_categoria_musica').classList.add('form-select');

    function toggleLoading(show, message) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
        loadingOverlay.querySelector('.loading-text').textContent = message;
    }

    function getYoutubeVideoId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    const formatTime = (seconds) => {
        const date = new Date(seconds * 1000);
        const minutes = date.getUTCMinutes();
        const secs = date.getUTCSeconds();
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    };

    analyzeBtn.addEventListener('click', async function() {
        const url = youtubeUrlInput.value;
        if (!url) {
            alert('Por favor, insira uma URL do YouTube.');
            return;
        }

        const videoId = getYoutubeVideoId(url);
        if (!videoId) {
            alert('URL do YouTube inválida.');
            return;
        }
        currentVideoId = videoId;

        toggleLoading(true, 'Analisando vídeo...');
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
        
        segmentsError.style.display = 'none';
        submitBtn.disabled = true;

        try {
            const response = await fetch("{% url 'get_youtube_segments' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ url: url })
            });
            
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Erro desconhecido.');
            
            previewPlaceholder.style.display = 'none';
            previewContent.style.display = 'block';

            if (data.segments && data.segments.length > 0) {
                player.cueVideoById(videoId);
                fetchedSegments = data.segments; // Armazena os segmentos

                const MAX_DURATION = 180;
                segmentsListContainer.innerHTML = '';

                data.segments.forEach((segment, index) => {
                    const isTooLong = segment.duration > MAX_DURATION;
                    const segmentId = index;

                    const segmentEl = document.createElement('div');
                    segmentEl.className = `segment-list-item ${isTooLong ? 'disabled' : ''}`;
                    segmentEl.dataset.segmentId = segmentId;
                    segmentEl.innerHTML = `
                        <div class="segment-checkbox">
                            <input type="checkbox" id="segment-check-${segmentId}" data-segment-id="${segmentId}" ${isTooLong ? 'disabled' : ''}>
                        </div>
                        <div class="segment-details">
                            <strong>Corte ${segmentId + 1}</strong>
                            <span>${formatTime(segment.start)} - ${formatTime(segment.end)}</span>
                        </div>
                        <div class="segment-duration">
                            ${Math.round(segment.duration)}s
                        </div>
                        <button type="button" class="btn-preview" data-start="${segment.start}" data-end="${segment.end}" ${isTooLong ? 'disabled' : ''}>
                            <i class="fas fa-play"></i>
                        </button>
                    `;
                    segmentsListContainer.appendChild(segmentEl);
                });

                step1.classList.remove('active');
                step2.classList.add('active');
                submitBtn.disabled = false;

            } else {
                segmentsError.textContent = data.message || 'Nenhum segmento popular foi encontrado.';
                segmentsError.style.display = 'block';
            }
        } catch (error) {
            segmentsError.textContent = 'Erro: ' + error.message;
            segmentsError.style.display = 'block';
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = 'Analisar Vídeo';
            toggleLoading(false, '');
        }
    });

    segmentsListContainer.addEventListener('click', function(e) {
        const item = e.target.closest('.segment-list-item');
        if (!item || item.classList.contains('disabled')) return;

        // Lógica do botão de preview
        if (e.target.closest('.btn-preview')) {
            const button = e.target.closest('.btn-preview');
            const start = parseFloat(button.dataset.start);
            const end = parseFloat(button.dataset.end);
            
            if(activePreviewTimeout) clearTimeout(activePreviewTimeout);

            player.seekTo(start);
            player.playVideo();
            
            activePreviewTimeout = setTimeout(() => {
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                     player.pauseVideo();
                }
            }, (end - start) * 1000);
            return; 
        }

        // Lógica de seleção do item
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox && !e.target.matches('input[type="checkbox"]')) {
            checkbox.checked = !checkbox.checked;
        }
        item.classList.toggle('selected', checkbox.checked);
    });

    submitBtn.addEventListener('click', function(e) {
        const selectedCheckboxes = segmentsListContainer.querySelectorAll('input[type="checkbox"]:checked');
        if (selectedCheckboxes.length === 0) {
            alert('Você deve selecionar pelo menos um segmento para gerar.');
            return;
        }

        const selectedSegments = Array.from(selectedCheckboxes).map(cb => {
            const segmentId = parseInt(cb.dataset.segmentId, 10);
            return fetchedSegments[segmentId];
        });

        hiddenSegmentsInput.value = JSON.stringify(selectedSegments);
        
        toggleLoading(true, 'Gerando cortes...');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';

        form.submit();
    });
});
</script>
{% endblock %}