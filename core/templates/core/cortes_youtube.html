{% extends 'core/base.html' %}
{% load static %}

{% block title %}Editor de Cortes Dinâmico - LUNDERON{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'core/css/editor_page.css' %}">
{% endblock %}

{% block content %}
<div class="editor-layout">
    <!-- PAINEL DE CONTROLE -->
    <aside class="editor-panel" id="editor-panel">
        <div class="panel-content-wrapper">
            <div class="panel-header">
                <h2>
                    <i class="fas fa-wand-magic-sparkles icon"></i>
                    Editor Mágico
                </h2>
            </div>

            <form id="youtube-cutter-form" method="post" class="panel-form">
                {% csrf_token %}
                <div class="form-content">

                    <!-- PASSO 1: INSERIR URL -->
                    <div class="form-step active" data-step="1">
                        <div class="form-group">
                            <label for="{{ form.youtube_url.id_for_label }}">Comece com um link do YouTube</label>
                            <div class="url-input-group">
                                {{ form.youtube_url }}
                                <i class="fas fa-link icon-prefix"></i>
                            </div>
                            <p class="form-text">Aguardando o player do YouTube para analisar...</p>
                        </div>
                    </div>

                    <!-- PASSO 2: DECK DE EDIÇÃO -->
                    <div class="form-step" data-step="2">
                        <div class="form-group">
                            <label>Cortes sugeridos</label>
                            <div id="segments-deck" class="segments-deck">
                                <!-- JS preencherá aqui -->
                            </div>
                        </div>
                        
                        <div class="additional-options">
                            <div class="form-group">
                                <label for="{{ form.categoria_musica.id_for_label }}">Música de Fundo</label>
                                {{ form.categoria_musica }}
                            </div>
                            <div class="form-group">
                                <label for="id_volume_musica">Volume da Música</label>
                                <div class="range-slider-group">
                                    <input type="range" name="volume_musica" value="20" class="form-range" min="0" max="100" id="id_volume_musica" oninput="this.nextElementSibling.value = this.value + '%'">
                                    <output>20%</output>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="id_gerar_legendas" class="form-check-wrapper">
                                    <input type="checkbox" class="form-check-input" id="id_gerar_legendas" name="gerar_legendas">
                                    <div class="form-check-info">
                                        <span class="form-check-title">Gerar Legendas com IA</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" name="segments" id="id_segments">

                <div class="panel-footer">
                    <div class="usage-alert">
                        Você tem <strong>{{ videos_restantes }}</strong> vídeo(s) restante(s).
                    </div>
                    <button type="button" id="main-action-btn" class="btn btn-primary btn-full btn-lg" disabled>
                        <i class="fas fa-spinner fa-spin"></i>
                        Carregando Player...
                    </button>
                </div>
            </form>
        </div>
    </aside>

    <!-- ÁREA DE PREVIEW DO VÍDEO -->
    <main class="editor-preview">
        <div class="preview-content-wrapper">
            <div id="loading-overlay" class="loading-overlay">
                <div class="loading-spinner"></div>
                <p class="loading-text">Analisando...</p>
            </div>
            
            <div id="preview-placeholder" class="preview-placeholder active">
                <i class="fab fa-youtube icon"></i>
                <h3>A prévia do seu vídeo aparecerá aqui</h3>
                <p>Cole uma URL para começar a mágica.</p>
            </div>

            <div id="preview-content" class="preview-content">
                <div class="video-preview-wrapper">
                    <div id="youtube-player"></div>
                </div>
                <div id="segments-error"></div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let currentVideoId;
let segmentsData = [];
let currentStep = 1;

// 1. A API do YouTube chama esta função quando está pronta.
function onYouTubeIframeAPIReady() {
    player = new YT.Player('youtube-player', {
        height: '100%',
        width: '100%',
        playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1 },
        events: {
            'onReady': onPlayerReady
        }
    });
}

// 2. Esta função é chamada quando o player do YouTube está totalmente carregado e pronto.
function onPlayerReady(event) {
    const mainActionBtn = document.getElementById('main-action-btn');
    const urlInput = document.getElementById('id_youtube_url');
    const formText = document.querySelector('.form-step[data-step="1"] .form-text');

    if(mainActionBtn) {
        mainActionBtn.disabled = false;
        mainActionBtn.innerHTML = '<i class="fas fa-magnifying-glass"></i> Analisar Vídeo';
    }
    if(urlInput) urlInput.disabled = false;
    if(formText) formText.textContent = 'Nossa IA vai analisar o vídeo e sugerir os melhores clipes para você.';
}

document.addEventListener('DOMContentLoaded', function() {
    // --- Seletores de Elementos --- 
    const form = document.getElementById('youtube-cutter-form');
    const mainActionBtn = document.getElementById('main-action-btn');
    const youtubeUrlInput = document.getElementById('id_youtube_url');
    const segmentsDeck = document.getElementById('segments-deck');
    const hiddenSegmentsInput = document.getElementById('id_segments');
    const loadingOverlay = document.getElementById('loading-overlay');
    const previewPlaceholder = document.getElementById('preview-placeholder');
    const previewContent = document.getElementById('preview-content');

    if(youtubeUrlInput) youtubeUrlInput.disabled = true;

    if(youtubeUrlInput) youtubeUrlInput.classList.add('form-input');
    const categoryMusic = document.getElementById('id_categoria_musica');
    if(categoryMusic) categoryMusic.classList.add('form-select');

    // --- Funções Principais ---

    function switchPanelStep(stepNumber) {
        const step1 = document.querySelector('.form-step[data-step="1"]');
        const step2 = document.querySelector('.form-step[data-step="2"]');
        currentStep = stepNumber;

        if (stepNumber === 2) {
            step1.classList.remove('active');
            step2.classList.add('active');
            mainActionBtn.innerHTML = '<i class="fas fa-rocket"></i> Gerar Cortes';
        } else {
            step2.classList.remove('active');
            step1.classList.add('active');
            mainActionBtn.innerHTML = '<i class="fas fa-magnifying-glass"></i> Analisar Vídeo';
        }
    }

    async function handleAnalyze() {
        if (!youtubeUrlInput.value) { alert('Por favor, insira uma URL do YouTube.'); return; }
        const videoId = getYoutubeVideoId(youtubeUrlInput.value);
        if (!videoId) { alert('URL do YouTube inválida.'); return; }
        
        currentVideoId = videoId;
        toggleLoading(true, 'Analisando o vídeo...');
        mainActionBtn.disabled = true;

        try {
            const response = await fetch("{% url 'get_youtube_segments' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ url: youtubeUrlInput.value })
            });
            
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Erro ao analisar o vídeo.');

            previewPlaceholder.classList.remove('active');
            previewContent.classList.add('active');

            if (data.segments && data.segments.length > 0) {
                if(player && typeof player.cueVideoById === 'function') player.cueVideoById(videoId);
                segmentsData = data.segments.map(s => ({...s, selected: true})); // All selected by default
                renderSegmentsList();
                switchPanelStep(2);
            } else {
                alert('Nenhum segmento popular foi encontrado.');
                previewPlaceholder.classList.add('active');
                previewContent.classList.remove('active');
            }
        } catch (error) {
            alert('Erro: ' + error.message);
        } finally {
            toggleLoading(false, '');
            mainActionBtn.disabled = false;
        }
    }

    function handleFormSubmit() {
        const selectedSegments = segmentsData.filter(s => s.selected);
        if (selectedSegments.length === 0) {
            alert('Você deve selecionar pelo menos um segmento para gerar.');
            return;
        }
        hiddenSegmentsInput.value = JSON.stringify(selectedSegments);
        
        toggleLoading(true, 'Gerando seus cortes...');
        mainActionBtn.disabled = true;
        mainActionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
        form.submit();
    }

    // --- Renderização e UI da Lista ---

    function renderSegmentsList() {
        if (!segmentsDeck) return;
        segmentsDeck.innerHTML = '';
        segmentsData.forEach((segment, index) => {
            const startTime = new Date(segment.start * 1000).toISOString().substr(14, 5);
            const endTime = new Date(segment.end * 1000).toISOString().substr(14, 5);
            
            const segmentElement = document.createElement('div');
            segmentElement.className = 'segment-item';
            segmentElement.dataset.index = index;

            segmentElement.innerHTML = `
                <label class="segment-checkbox">
                   <input class="form-check-input" type="checkbox" data-index="${index}" ${segment.selected ? 'checked' : ''}>
                   <span class="checkbox-visual"><i class="fas fa-check"></i></span>
                </label>
                <div class="segment-info">
                    <strong>Corte ${index + 1}</strong>
                    <span>${startTime} - ${endTime}</span>
                </div>
                <span class="segment-duration">${Math.round(segment.duration)}s</span>
                <button type="button" class="btn-preview" data-start="${segment.start}" data-end="${segment.end}" title="Pré-visualizar corte">
                    <i class="fas fa-play"></i>
                </button>
            `;
            segmentsDeck.appendChild(segmentElement);
        });
    }

    // --- Event Listeners ---

    mainActionBtn.addEventListener('click', () => {
        if (currentStep === 1) {
            handleAnalyze();
        } else {
            handleFormSubmit();
        }
    });

    if(segmentsDeck) {
        segmentsDeck.addEventListener('click', e => {
            const previewBtn = e.target.closest('.btn-preview');
            const item = e.target.closest('.segment-item');
            
            if (previewBtn) {
                e.stopPropagation(); // Prevent item click when clicking preview
                const index = parseInt(item.dataset.index, 10);
                if(player && typeof player.loadVideoById === 'function') {
                    player.loadVideoById({ videoId: currentVideoId, startSeconds: segmentsData[index].start, endSeconds: segmentsData[index].end });
                }
                return;
            }

            if (item) {
                const index = parseInt(item.dataset.index, 10);
                const checkbox = item.querySelector('input[type="checkbox"]');
                
                // Toggle selection state in data model
                // Only if the click was not on the checkbox itself
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                }
                segmentsData[index].selected = checkbox.checked;
            }
        });
    }

    // --- Funções Utilitárias ---
    function toggleLoading(show, message) {
        if(loadingOverlay) {
            loadingOverlay.querySelector('.loading-text').textContent = message;
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
    }
    function getYoutubeVideoId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }
});
</script>
{% endblock %}