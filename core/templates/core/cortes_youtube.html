{% extends 'core/base.html' %}
{% load static %}

{% block title %}Editor de Cortes do YouTube - LUNDERON{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/editor_page.css' %}">
{% endblock %}

{% block content %}
<div class="editor-layout">
    <aside class="editor-panel">
        <div class="panel-header">
            <i class="fas fa-cut"></i>
            <h2>Editor de Cortes</h2>
        </div>

        <form id="youtube-cutter-form" method="post" class="panel-form">
            {% csrf_token %}
            
            <div class="form-step-wrapper">
                <div class="form-step active" data-step="1">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h3>Cole a URL do Vídeo</h3>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.youtube_url.id_for_label }}">URL do YouTube</label>
                        {{ form.youtube_url }}
                    </div>
                    <button type="button" id="analyze-btn" class="btn btn-primary btn-full">Analisar Vídeo</button>
                    <div class="form-text">Cole a URL completa para que nossa IA encontre os melhores momentos.</div>
                </div>

                <div class="form-step" data-step="2">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h3>Selecione os Cortes e Opções</h3>
                    </div>
                    
                    <div id="segments-container" class="form-group">
                        <label>Segmentos Encontrados (Clique em ▶️ para pré-visualizar)</label>
                        <div id="segments-list">
                            </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.categoria_musica.id_for_label }}">Música de Fundo</label>
                        {{ form.categoria_musica }}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_volume_musica">Volume da Música (%)</label>
                        <div class="range-slider-group">
                            <input type="range" name="volume_musica" value="20" class="form-range" min="0" max="100" id="id_volume_musica" oninput="this.nextElementSibling.value = this.value">
                            <output>20</output>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-check-wrapper">
                            <input type="checkbox" class="form-check-input" id="id_gerar_legendas" name="gerar_legendas">
                            <div class="form-check-info">
                                <span class="form-check-title">Gerar Legendas (IA)</span>
                                <small class="form-text">Ativa a transcrição automática do áudio para legendas.</small>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <input type="hidden" name="segments" id="id_segments">
            <div class="panel-footer">
                <div class="alert alert-info">
                    Você tem <strong>{{ videos_restantes }}</strong> vídeo(s) restante(s) no seu limite.
                </div>
                <button type="submit" id="submit-btn" class="btn btn-primary btn-full btn-lg" disabled>Gerar Cortes Selecionados</button>
            </div>
        </form>
    </aside>

    <main class="editor-preview">
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <p class="loading-text">Analisando...</p>
        </div>
        
        <div id="preview-placeholder" class="preview-placeholder">
            <i class="fab fa-youtube"></i>
            <h3>Sua prévia aparecerá aqui</h3>
            <p>Cole uma URL e clique em "Analisar Vídeo" para começar.</p>
        </div>

        <div id="preview-content" class="preview-content">
            <div class="video-preview-wrapper">
                <div id="youtube-player"></div>

                </div>
            <div id="segments-error" class="alert alert-danger" style="display: none;"></div>
        </div>
    </main>
</div>
{% endblock %}


{% block scripts %}
{{ block.super }}
<script src="https://www.youtube.com/iframe_api"></script>

<script>
// 2. Variáveis globais para o player e o videoId
let player;
let currentVideoId;

// 3. Função que a API do YouTube chama automaticamente quando está pronta
function onYouTubeIframeAPIReady() {
    player = new YT.Player('youtube-player', {
        height: '100%',
        width: '100%',
        playerVars: {
            'playsinline': 1,
            'controls': 0, // Desativa os controles padrão para uma experiência limpa
            'rel': 0,      // Não mostra vídeos relacionados no final
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Mapeamento de elementos
    const form = document.getElementById('youtube-cutter-form');
    const analyzeBtn = document.getElementById('analyze-btn');
    const submitBtn = document.getElementById('submit-btn');
    const youtubeUrlInput = document.getElementById('id_youtube_url');
    const segmentsList = document.getElementById('segments-list');
    const segmentsError = document.getElementById('segments-error');
    const hiddenSegmentsInput = document.getElementById('id_segments');
    
    const previewPlaceholder = document.getElementById('preview-placeholder');
    const previewContent = document.getElementById('preview-content');
    
    const step1 = document.querySelector('.form-step[data-step="1"]');
    const step2 = document.querySelector('.form-step[data-step="2"]');
    const loadingOverlay = document.getElementById('loading-overlay');

    // Adiciona classes aos campos do Django
    youtubeUrlInput.classList.add('form-input');
    document.getElementById('id_categoria_musica').classList.add('form-select');

    function toggleLoading(show, message) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
        loadingOverlay.querySelector('.loading-text').textContent = message;
    }

    function getYoutubeVideoId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    analyzeBtn.addEventListener('click', async function() {
        const url = youtubeUrlInput.value;
        if (!url) {
            alert('Por favor, insira uma URL do YouTube.');
            return;
        }

        const videoId = getYoutubeVideoId(url);
        if (!videoId) {
            alert('URL do YouTube inválida.');
            return;
        }
        currentVideoId = videoId; // Armazena o ID do vídeo atual

        toggleLoading(true, 'Analisando vídeo...');
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
        
        segmentsList.innerHTML = '';
        segmentsError.style.display = 'none';
        submitBtn.disabled = true;

        try {
            const response = await fetch("{% url 'get_youtube_segments' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ url: url })
            });
            
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Erro desconhecido.');
            
            // Mostra o player em vez da thumbnail
            previewPlaceholder.style.display = 'none';
            previewContent.style.display = 'block';

            if (data.segments && data.segments.length > 0) {
                // Carrega o vídeo no player, mas não toca ainda
                player.cueVideoById(videoId);

                data.segments.forEach((segment, index) => {
                    const startTime = new Date(segment.start * 1000).toISOString().substr(14, 5);
                    const endTime = new Date(segment.end * 1000).toISOString().substr(14, 5);
                    
                    const DURATION_LIMIT = 180; // 3 minutos
                    const isOverLimit = segment.duration > DURATION_LIMIT;

                    const segmentElement = document.createElement('div');
                    segmentElement.className = 'segment-item';
                    if (isOverLimit) {
                        segmentElement.classList.add('disabled');
                    }

                    let warningMessage = '';
                    if (isOverLimit) {
                        warningMessage = `<small class="text-danger d-block">Duração excede 3 min.</small>`;
                    }

                    segmentElement.innerHTML = `
                        <label class="segment-checkbox">
                           <input class="form-check-input" type="checkbox" value='${JSON.stringify(segment)}' id="segment-${index}" ${isOverLimit ? 'disabled' : 'checked'}>
                        </label>
                        <div class="segment-info">
                            <strong>Corte ${index + 1}</strong>
                            <span>${startTime} - ${endTime}</span>
                            ${warningMessage}
                        </div>
                        <span class="segment-duration ${isOverLimit ? 'text-danger' : ''}">${Math.round(segment.duration)}s</span>
                        <button type="button" class="btn-preview" data-start="${segment.start}" data-end="${segment.end}" title="Assistir prévia">
                            <i class="fas fa-play"></i>
                        </button>
                    `;
                    segmentsList.appendChild(segmentElement);
                });
                
                step1.classList.remove('active');
                step2.classList.add('active');
                submitBtn.disabled = false;
            } else {
                segmentsError.textContent = data.message || 'Nenhum segmento popular foi encontrado.';
                segmentsError.style.display = 'block';
            }
        } catch (error) {
            segmentsError.textContent = 'Erro: ' + error.message;
            segmentsError.style.display = 'block';
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = 'Analisar Vídeo';
            toggleLoading(false, '');
        }
    });

    // 5. Event listener para os botões de pré-visualização
    segmentsList.addEventListener('click', function(e) {
        const previewBtn = e.target.closest('.btn-preview');
        if (previewBtn) {
            const startSeconds = parseFloat(previewBtn.dataset.start);
            const endSeconds = parseFloat(previewBtn.dataset.end);
            
            if (player && typeof player.loadVideoById === 'function') {
                player.loadVideoById({
                    videoId: currentVideoId,
                    startSeconds: startSeconds,
                    endSeconds: endSeconds
                });
            }
        }
    });

    form.addEventListener('submit', function(e) {
        const selectedCheckboxes = segmentsList.querySelectorAll('input[type="checkbox"]:checked');
        if (selectedCheckboxes.length === 0) {
            e.preventDefault();
            alert('Você deve selecionar pelo menos um segmento para gerar.');
            return;
        }

        const selectedSegments = Array.from(selectedCheckboxes).map(cb => JSON.parse(cb.value));
        hiddenSegmentsInput.value = JSON.stringify(selectedSegments);
        
        toggleLoading(true, 'Gerando cortes...');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
    });
});
</script>

<style>
    .segment-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .segment-checkbox {
        display: flex;
        align-items: center;
    }
    .btn-preview {
        background: var(--color-secondary);
        color: var(--color-primary);
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        margin-left: auto;
        transition: background-color 0.2s;
    }
    .btn-preview:hover {
        background-color: var(--color-secondary-dark);
    }
</style>

{% endblock %}
<style>
    .segment-item.disabled {
        opacity: 0.6;
        background-color: #f8f9fa;
        border-left: 3px solid #dc3545;
        padding-left: 10px;
    }
    .segment-item.disabled .segment-info strong {
        text-decoration: line-through;
    }
    .text-danger {
        color: #dc3545;
        font-weight: bold;
    }
    .d-block {
        display: block;
    }
</style>