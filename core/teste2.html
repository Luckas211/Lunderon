<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solução para Problemas de CSRF e Configuração</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
        }

        h1 {
            border-bottom: 2px solid #4A76CF;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        h2 {
            border-left: 4px solid #4A76CF;
            padding-left: 15px;
            margin-top: 40px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .problem {
            border-left: 4px solid #e74c3c;
            background-color: #ffebee;
        }

        .solution {
            border-left: 4px solid #2ecc71;
            background-color: #e8f5e9;
        }

        .code {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Consolas', monospace;
        }

        .important {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .success {
            background-color: #e8f5e9;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #4caf50;
        }

        .step {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        ul {
            padding-left: 20px;
        }

        li {
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <h1>Solução para Problemas de CSRF e Configuração no Django</h1>

    <div class="card problem">
        <h2>Problemas Identificados</h2>
        <p>Com base nos logs fornecidos, identifiquei os seguintes problemas:</p>
        <ul>
            <li>Erros de verificação de origem CSRF (403 Forbidden)</li>
            <li>Domínios do ngrok não configurados como origens confiáveis</li>
            <li>Possível falta de tokens CSRF em formulários</li>
            <li>Problemas de configuração com o servidor ngrok</li>
        </ul>
    </div>

    <div class="card solution">
        <h2>Soluções Implementadas</h2>

        <div class="step">
            <h3>1. Configurar CSRF_TRUSTED_ORIGINS no Django</h3>
            <p>Adicione os domínios do ngrok às origens confiáveis no arquivo <code>settings.py</code>:</p>
            <div class="code">
                # settings.py<br>
                CSRF_TRUSTED_ORIGINS = [<br>
                &nbsp;&nbsp;&nbsp;&nbsp;'https://f401576f41b0.ngrok-free.app',<br>
                &nbsp;&nbsp;&nbsp;&nbsp;'https://eb9cc2532f75.ngrok-free.app',<br>
                &nbsp;&nbsp;&nbsp;&nbsp;'https://d8cc2532577.org.uk-free.app'<br>
                ]<br>
                <br>
                # Se você quiser aceitar qualquer subdomínio ngrok<br>
                CSRF_TRUSTED_ORIGINS = [<br>
                &nbsp;&nbsp;&nbsp;&nbsp;'https://*.ngrok-free.app',<br>
                &nbsp;&nbsp;&nbsp;&nbsp;'https://*.ngrok.io'<br>
                ]
            </div>
        </div>

        <div class="step">
            <h3>2. Configurar ALLOWED_HOSTS corretamente</h3>
            <p>Atualize a lista de hosts permitidos no Django:</p>
            <div class="code">
                # settings.py<br>
                ALLOWED_HOSTS = [<br>
                &nbsp;&nbsp;&nbsp;&nbsp;'localhost',<br>
                &nbsp;&nbsp;&nbsp;&nbsp;'127.0.0.1',<br>
                &nbsp;&nbsp;&nbsp;&nbsp;'.ngrok-free.app',<br>
                &nbsp;&nbsp;&nbsp;&nbsp;'.ngrok.io'<br>
                ]
            </div>
        </div>

        <div class="step">
            <h3>3. Garantir que o CSRF token está presente nos formulários</h3>
            <p>Certifique-se de que todos os formulários POST incluam o token CSRF:</p>
            <div class="code">
                &lt;form method="post"&gt;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;{% csrf_token %}<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&lt;!-- outros campos do formulário --&gt;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&lt;button type="submit"&gt;Enviar&lt;/button&gt;<br>
                &lt;/form&gt;
            </div>
        </div>

        <div class="step">
            <h3>4. Configurar o Ngrok corretamente</h3>
            <p>Use o comando correto para iniciar o túnel ngrok:</p>
            <div class="code">
                # Para expor sua aplicação Django na porta 8000<br>
                ngrok http 8000<br>
                <br>
                # Se estiver usando outra porta, ajuste conforme necessário<br>
                ngrok http 8080
            </div>
            <div class="important">
                <p><strong>Importante:</strong> Certifique-se de que o servidor Django está rodando antes de iniciar o
                    ngrok.</p>
            </div>
        </div>

        <div class="step">
            <h3>5. Configurar o Webhook do Stripe</h3>
            <p>No painel do Stripe, configure o webhook para apontar para sua URL do ngrok:</p>
            <div class="code">
                URL do endpoint: https://f401576f41b0.ngrok-free.app/webhook/stripe/<br>
                Eventos a serem enviados:<br>
                - checkout.session.completed<br>
                - customer.subscription.deleted
            </div>
        </div>

        <div class="step">
            <h3>6. Configurações de Proxy no Django</h3>
            <p>Adicione estas configurações para garantir que o Django funcione bem atrás do ngrok:</p>
            <div class="code">
                # settings.py<br>
                USE_X_FORWARDED_HOST = True<br>
                SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
            </div>
        </div>

        <div class="success">
            <h3>Verificação Final</h3>
            <p>Após aplicar estas configurações, reinicie o servidor Django e o ngrok, e teste novamente.</p>
            <p>Verifique se:</p>
            <ul>
                <li>O servidor Django está rodando na porta correta</li>
                <li>O ngrok está apontando para a mesma porta</li>
                <li>As URLs no Stripe estão atualizadas com o domínio atual do ngrok</li>
                <li>Os tokens CSRF estão presentes em todos os formulários</li>
            </ul>
        </div>
    </div>

    <div class="card">
        <h2>Configuração Adicional para Produção</h2>
        <div class="important">
            <p>Lembre-se que o servidor de desenvolvimento do Django não é adequado para produção. Para implantação em
                produção:</p>
            <ul>
                <li>Use um servidor WSGI como Gunicorn ou uWSGI</li>
                <li>Configure um servidor web como Nginx ou Apache</li>
                <li>Defina <code>DEBUG = False</code> no settings.py</li>
                <li>Configure corretamente as variáveis de ambiente e segredos</li>
            </ul>
        </div>
    </div>
</body>

</html>